#!/usr/bin/env bash
# Pre-commit hook to prevent committing secrets
# Auto-installed by git-hooks setup

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸ” Scanning for secrets...${NC}"

# Get list of files to be committed
FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$FILES" ]; then
    echo -e "${GREEN}âœ“ No files to check${NC}"
    exit 0
fi

FOUND_SECRETS=0

# Pattern detection
check_patterns() {
    local file=$1
    local patterns=(
        # API Keys
        'sk-ant-api[0-9]{2}-[A-Za-z0-9_-]{20,}'  # Anthropic (min 20 chars)
        '[0-9]{10}:[A-Za-z0-9_-]{35}'            # Telegram Bot Token
        'sk_[a-zA-Z0-9]{20,}'                    # Generic API keys (min 20)
        'AIza[0-9A-Za-z_-]{35}'                  # Google API
        'AKIA[0-9A-Z]{16}'                       # AWS Access Key
        
        # Private Keys
        '0x[a-fA-F0-9]{64}'                      # Ethereum/NEO private keys
        '-----BEGIN.*PRIVATE KEY-----'           # PEM keys
        
        # Tokens
        'ghp_[a-zA-Z0-9]{36}'                    # GitHub Personal Token
        'gho_[a-zA-Z0-9]{36}'                    # GitHub OAuth Token
        'ghs_[a-zA-Z0-9]{36}'                    # GitHub Secret Token
        
        # Other sensitive patterns
        'ANTHROPIC_API_KEY\s*=\s*.+'             # Anthropic key in env
        'TELEGRAM_BOT_TOKEN\s*=\s*.+'            # Telegram token in env
        'NEO_.*_PRIVATE_KEY\s*=\s*0x[a-fA-F0-9]+' # NEO keys
        'password\s*=\s*["\x27][^"\x27]{8,}'     # Passwords in code
        'api[_-]?key\s*=\s*["\x27][^"\x27]{16,}' # API keys in code
    )
    
    for pattern in "${patterns[@]}"; do
        if grep -qE "$pattern" "$file" 2>/dev/null; then
            echo -e "${RED}âœ— Potential secret found in: $file${NC}"
            echo -e "${RED}  Pattern: $pattern${NC}"
            grep -nE "$pattern" "$file" | head -3
            return 1
        fi
    done
    
    return 0
}

# Check each file
for file in $FILES; do
    # Skip if file doesn't exist (deleted)
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # Always block .env files (unless .example)
    if [[ "$file" =~ \.env$ ]] && [[ ! "$file" =~ \.env\.example$ ]]; then
        echo -e "${RED}âœ— BLOCKED: Attempting to commit .env file${NC}"
        echo -e "${RED}  File: $file${NC}"
        echo -e "${YELLOW}  Hint: Use .env.example instead${NC}"
        FOUND_SECRETS=1
        continue
    fi
    
    # Block private key files
    if [[ "$file" =~ \.(pem|key|p12|pfx)$ ]]; then
        echo -e "${RED}âœ— BLOCKED: Attempting to commit key file${NC}"
        echo -e "${RED}  File: $file${NC}"
        FOUND_SECRETS=1
        continue
    fi
    
    # Block NEO identity files
    if [[ "$file" =~ \.neo-identities/.*\.json$ ]] && [[ ! "$file" =~ \.example$ ]]; then
        if grep -q "PRIVATE_KEY" "$file" 2>/dev/null; then
            echo -e "${RED}âœ— BLOCKED: NEO identity file with private key${NC}"
            echo -e "${RED}  File: $file${NC}"
            FOUND_SECRETS=1
            continue
        fi
    fi
    
    # Block FlowPay sensitive data
    if [[ "$file" =~ data/flowpay/(orders|receipts)/.*\.json$ ]]; then
        echo -e "${RED}âœ— BLOCKED: FlowPay sensitive data${NC}"
        echo -e "${RED}  File: $file${NC}"
        echo -e "${YELLOW}  Hint: Only commit .gitkeep files${NC}"
        FOUND_SECRETS=1
        continue
    fi
    
    # Check file content for patterns
    if ! check_patterns "$file"; then
        FOUND_SECRETS=1
    fi
done

# Results
if [ $FOUND_SECRETS -eq 0 ]; then
    echo -e "${GREEN}âœ“ No secrets detected. Safe to commit.${NC}"
    exit 0
else
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  COMMIT BLOCKED: SECRETS DETECTED     â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Actions you can take:${NC}"
    echo "1. Remove the secrets from the files"
    echo "2. Add the files to .gitignore"
    echo "3. Use environment variables instead"
    echo "4. Use .env.example with placeholder values"
    echo ""
    echo -e "${YELLOW}To bypass this check (NOT RECOMMENDED):${NC}"
    echo "git commit --no-verify"
    echo ""
    exit 1
fi
