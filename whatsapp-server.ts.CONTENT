import makeWASocket, {
  DisconnectReason,
  useMultiFileAuthState,
  fetchLatestBaileysVersion
} from "@whiskeysockets/baileys";
import { Boom } from "@hapi/boom";
import pino from "pino";
import qrcode from "qrcode-terminal"; // @ts-ignore

const SESSION_DIR = process.env.WHATSAPP_SESSION_DIR || "./data/whatsapp-session";

async function connectToWhatsApp() {
  console.log("ðŸ¦ž [FlowCloser FÃªnix] Inicializando State em:", SESSION_DIR);
  // Garante que o diretÃ³rio existe (se estiver no Railway, precisa de permissÃ£o de escrita)
  const { state, saveCreds } = await useMultiFileAuthState(SESSION_DIR);
  const { version } = await fetchLatestBaileysVersion();
  
  console.log(`ðŸ¦ž [FlowCloser FÃªnix] Iniciando WhatsApp v${version.join(".")}...`);

  const sock = makeWASocket({
    version,
    logger: pino({ level: "silent" }),
    printQRInTerminal: true,
    auth: state,
    browser: ["FlowCloser FÃªnix", "Chrome", "1.0.0"],
    syncFullHistory: false,
    generateHighQualityLinkPreview: true
  });

  sock.ev.on("connection.update", (update) => {
    const { connection, lastDisconnect, qr } = update;

    if (qr) {
      console.log("\nâš ï¸  QR Code Recebido - ESCANEIE ABAIXO:\n");
      qrcode.generate(qr, { small: true });
    }

    if (connection === "close") {
      const shouldReconnect =
        (lastDisconnect?.error as Boom)?.output?.statusCode !==
        DisconnectReason.loggedOut;
      
      console.log(
        "âŒ ConexÃ£o fechada. Reconectando:",
        shouldReconnect
      );

      if (shouldReconnect) {
        setTimeout(connectToWhatsApp, 5000); 
      }
    } else if (connection === "open") {
      console.log("âœ… [FlowCloser FÃªnix] WhatsApp Conectado com Sucesso! ðŸ”¥ðŸ¦…");
    }
  });

  sock.ev.on("creds.update", saveCreds);

  sock.ev.on("messages.upsert", async (m) => {
    if (m.type !== "notify") return;
    
    for (const msg of m.messages) {
      if (!msg.message || msg.key.fromMe) continue;

      const remoteJid = msg.key.remoteJid!;
      const text =
        msg.message.conversation ||
        msg.message.extendedTextMessage?.text ||
        msg.message.imageMessage?.caption;

      if (!text) continue;

      console.log(`ðŸ“© Mensagem de ${remoteJid}: ${text}`);

      // Auto-reply FÃªnix
      await sock.sendMessage(remoteJid, {
        text: "ðŸ”¥ðŸ¦… *FlowCloser FÃªnix*\n\nEstou online e operando em modo soberano.\n\nRecebi: " + text
      });
    }
  });
}

connectToWhatsApp();
