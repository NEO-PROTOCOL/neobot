{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{lookupContextTokens}from\"../agents/context.js\";import{DEFAULT_CONTEXT_TOKENS,DEFAULT_MODEL,DEFAULT_PROVIDER}from\"../agents/defaults.js\";import{resolveConfiguredModelRef}from\"../agents/model-selection.js\";import{loadConfig}from\"../config/config.js\";import{loadSessionStore,resolveStorePath}from\"../config/sessions.js\";import{info}from\"../globals.js\";import{isRich,theme}from\"../terminal/theme.js\";const KIND_PAD=6;const KEY_PAD=26;const AGE_PAD=9;const MODEL_PAD=14;const TOKENS_PAD=20;const formatKTokens=__name(value=>`${(value/1e3).toFixed(value>=1e4?0:1)}k`,\"formatKTokens\");const truncateKey=__name(key=>{if(key.length<=KEY_PAD)return key;const head=Math.max(4,KEY_PAD-10);return`${key.slice(0,head)}...${key.slice(-6)}`},\"truncateKey\");const colorByPct=__name((label,pct,rich)=>{if(!rich||pct===null)return label;if(pct>=95)return theme.error(label);if(pct>=80)return theme.warn(label);if(pct>=60)return theme.success(label);return theme.muted(label)},\"colorByPct\");const formatTokensCell=__name((total,contextTokens,rich)=>{if(!total)return\"-\".padEnd(TOKENS_PAD);const totalLabel=formatKTokens(total);const ctxLabel=contextTokens?formatKTokens(contextTokens):\"?\";const pct=contextTokens?Math.min(999,Math.round(total/contextTokens*100)):null;const label=`${totalLabel}/${ctxLabel} (${pct??\"?\"}%)`;const padded=label.padEnd(TOKENS_PAD);return colorByPct(padded,pct,rich)},\"formatTokensCell\");const formatKindCell=__name((kind,rich)=>{const label=kind.padEnd(KIND_PAD);if(!rich)return label;if(kind===\"group\")return theme.accentBright(label);if(kind===\"global\")return theme.warn(label);if(kind===\"direct\")return theme.accent(label);return theme.muted(label)},\"formatKindCell\");const formatAgeCell=__name((updatedAt,rich)=>{const ageLabel=updatedAt?formatAge(Date.now()-updatedAt):\"unknown\";const padded=ageLabel.padEnd(AGE_PAD);return rich?theme.muted(padded):padded},\"formatAgeCell\");const formatModelCell=__name((model,rich)=>{const label=(model??\"unknown\").padEnd(MODEL_PAD);return rich?theme.info(label):label},\"formatModelCell\");const formatFlagsCell=__name((row,rich)=>{const flags=[row.thinkingLevel?`think:${row.thinkingLevel}`:null,row.verboseLevel?`verbose:${row.verboseLevel}`:null,row.reasoningLevel?`reasoning:${row.reasoningLevel}`:null,row.elevatedLevel?`elev:${row.elevatedLevel}`:null,row.responseUsage?`usage:${row.responseUsage}`:null,row.groupActivation?`activation:${row.groupActivation}`:null,row.systemSent?\"system\":null,row.abortedLastRun?\"aborted\":null,row.sessionId?`id:${row.sessionId}`:null].filter(Boolean);const label=flags.join(\" \");return label.length===0?\"\":rich?theme.muted(label):label},\"formatFlagsCell\");const formatAge=__name(ms=>{if(!ms||ms<0)return\"unknown\";const minutes=Math.round(ms/6e4);if(minutes<1)return\"just now\";if(minutes<60)return`${minutes}m ago`;const hours=Math.round(minutes/60);if(hours<48)return`${hours}h ago`;const days=Math.round(hours/24);return`${days}d ago`},\"formatAge\");function classifyKey(key,entry){if(key===\"global\")return\"global\";if(key===\"unknown\")return\"unknown\";if(entry?.chatType===\"group\"||entry?.chatType===\"channel\"){return\"group\"}if(key.includes(\":group:\")||key.includes(\":channel:\")){return\"group\"}return\"direct\"}__name(classifyKey,\"classifyKey\");function toRows(store){return Object.entries(store).map(([key,entry])=>{const updatedAt=entry?.updatedAt??null;return{key,kind:classifyKey(key,entry),updatedAt,ageMs:updatedAt?Date.now()-updatedAt:null,sessionId:entry?.sessionId,systemSent:entry?.systemSent,abortedLastRun:entry?.abortedLastRun,thinkingLevel:entry?.thinkingLevel,verboseLevel:entry?.verboseLevel,reasoningLevel:entry?.reasoningLevel,elevatedLevel:entry?.elevatedLevel,responseUsage:entry?.responseUsage,groupActivation:entry?.groupActivation,inputTokens:entry?.inputTokens,outputTokens:entry?.outputTokens,totalTokens:entry?.totalTokens,model:entry?.model,contextTokens:entry?.contextTokens}}).sort((a,b)=>(b.updatedAt??0)-(a.updatedAt??0))}__name(toRows,\"toRows\");async function sessionsCommand(opts,runtime){const cfg=loadConfig();const resolved=resolveConfiguredModelRef({cfg,defaultProvider:DEFAULT_PROVIDER,defaultModel:DEFAULT_MODEL});const configContextTokens=cfg.agents?.defaults?.contextTokens??lookupContextTokens(resolved.model)??DEFAULT_CONTEXT_TOKENS;const configModel=resolved.model??DEFAULT_MODEL;const storePath=resolveStorePath(opts.store??cfg.session?.store);const store=loadSessionStore(storePath);let activeMinutes;if(opts.active!==void 0){const parsed=Number.parseInt(String(opts.active),10);if(Number.isNaN(parsed)||parsed<=0){runtime.error(\"--active must be a positive integer (minutes)\");runtime.exit(1);return}activeMinutes=parsed}const rows=toRows(store).filter(row=>{if(activeMinutes===void 0)return true;if(!row.updatedAt)return false;return Date.now()-row.updatedAt<=activeMinutes*6e4});if(opts.json){runtime.log(JSON.stringify({path:storePath,count:rows.length,activeMinutes:activeMinutes??null,sessions:rows.map(r=>({...r,contextTokens:r.contextTokens??lookupContextTokens(r.model)??configContextTokens??null,model:r.model??configModel??null}))},null,2));return}runtime.log(info(`Session store: ${storePath}`));runtime.log(info(`Sessions listed: ${rows.length}`));if(activeMinutes){runtime.log(info(`Filtered to last ${activeMinutes} minute(s)`))}if(rows.length===0){runtime.log(\"No sessions found.\");return}const rich=isRich();const header=[\"Kind\".padEnd(KIND_PAD),\"Key\".padEnd(KEY_PAD),\"Age\".padEnd(AGE_PAD),\"Model\".padEnd(MODEL_PAD),\"Tokens (ctx %)\".padEnd(TOKENS_PAD),\"Flags\"].join(\" \");runtime.log(rich?theme.heading(header):header);for(const row of rows){const model=row.model??configModel;const contextTokens=row.contextTokens??lookupContextTokens(model)??configContextTokens;const input=row.inputTokens??0;const output=row.outputTokens??0;const total=row.totalTokens??input+output;const keyLabel=truncateKey(row.key).padEnd(KEY_PAD);const keyCell=rich?theme.accent(keyLabel):keyLabel;const line=[formatKindCell(row.kind,rich),keyCell,formatAgeCell(row.updatedAt,rich),formatModelCell(model,rich),formatTokensCell(total,contextTokens??null,rich),formatFlagsCell(row,rich)].join(\" \");runtime.log(line.trimEnd())}}__name(sessionsCommand,\"sessionsCommand\");export{sessionsCommand};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/nettomello/CODIGOS/neobot/src/commands/sessions.ts"],"sourcesContent":[null]}}