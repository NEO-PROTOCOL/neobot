{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{MoltbotSchema,CONFIG_PATH,migrateLegacyConfig,readConfigFileSnapshot}from\"../config/config.js\";import{applyPluginAutoEnable}from\"../config/plugin-auto-enable.js\";import{formatCliCommand}from\"../cli/command-format.js\";import{note}from\"../terminal/note.js\";import{normalizeLegacyConfigValues}from\"./doctor-legacy-config.js\";function isRecord(value){return Boolean(value&&typeof value===\"object\"&&!Array.isArray(value))}__name(isRecord,\"isRecord\");function normalizeIssuePath(path){return path.filter(part=>typeof part!==\"symbol\")}__name(normalizeIssuePath,\"normalizeIssuePath\");function isUnrecognizedKeysIssue(issue){return issue.code===\"unrecognized_keys\"}__name(isUnrecognizedKeysIssue,\"isUnrecognizedKeysIssue\");function formatPath(parts){if(parts.length===0)return\"<root>\";let out=\"\";for(const part of parts){if(typeof part===\"number\"){out+=`[${part}]`;continue}out=out?`${out}.${part}`:part}return out||\"<root>\"}__name(formatPath,\"formatPath\");function resolvePathTarget(root,path){let current=root;for(const part of path){if(typeof part===\"number\"){if(!Array.isArray(current))return null;if(part<0||part>=current.length)return null;current=current[part];continue}if(!current||typeof current!==\"object\"||Array.isArray(current))return null;const record=current;if(!(part in record))return null;current=record[part]}return current}__name(resolvePathTarget,\"resolvePathTarget\");function stripUnknownConfigKeys(config){const parsed=MoltbotSchema.safeParse(config);if(parsed.success){return{config,removed:[]}}const next=structuredClone(config);const removed=[];for(const issue of parsed.error.issues){if(!isUnrecognizedKeysIssue(issue))continue;const path=normalizeIssuePath(issue.path);const target=resolvePathTarget(next,path);if(!target||typeof target!==\"object\"||Array.isArray(target))continue;const record=target;for(const key of issue.keys){if(typeof key!==\"string\")continue;if(!(key in record))continue;delete record[key];removed.push(formatPath([...path,key]))}}return{config:next,removed}}__name(stripUnknownConfigKeys,\"stripUnknownConfigKeys\");function noteOpencodeProviderOverrides(cfg){const providers=cfg.models?.providers;if(!providers)return;const overrides=[];if(providers.opencode)overrides.push(\"opencode\");if(providers[\"opencode-zen\"])overrides.push(\"opencode-zen\");if(overrides.length===0)return;const lines=overrides.flatMap(id=>{const providerEntry=providers[id];const api=isRecord(providerEntry)&&typeof providerEntry.api===\"string\"?providerEntry.api:void 0;return[`- models.providers.${id} is set; this overrides the built-in OpenCode Zen catalog.`,api?`- models.providers.${id}.api=${api}`:null].filter(line=>Boolean(line))});lines.push(\"- Remove these entries to restore per-model API routing + costs (then re-run onboarding if needed).\");note(lines.join(\"\\n\"),\"OpenCode Zen\")}__name(noteOpencodeProviderOverrides,\"noteOpencodeProviderOverrides\");async function loadAndMaybeMigrateDoctorConfig(params){const shouldRepair=params.options.repair===true||params.options.yes===true;const snapshot=await readConfigFileSnapshot();const baseCfg=snapshot.config??{};let cfg=baseCfg;let candidate=structuredClone(baseCfg);let pendingChanges=false;let shouldWriteConfig=false;const fixHints=[];if(snapshot.exists&&!snapshot.valid&&snapshot.legacyIssues.length===0){note(\"Config invalid; doctor will run with best-effort config.\",\"Config\")}const warnings=snapshot.warnings??[];if(warnings.length>0){const lines=warnings.map(issue=>`- ${issue.path}: ${issue.message}`).join(\"\\n\");note(lines,\"Config warnings\")}if(snapshot.legacyIssues.length>0){note(snapshot.legacyIssues.map(issue=>`- ${issue.path}: ${issue.message}`).join(\"\\n\"),\"Legacy config keys detected\");const{config:migrated,changes}=migrateLegacyConfig(snapshot.parsed);if(changes.length>0){note(changes.join(\"\\n\"),\"Doctor changes\")}if(migrated){candidate=migrated;pendingChanges=pendingChanges||changes.length>0}if(shouldRepair){if(migrated)cfg=migrated}else{fixHints.push(`Run \"${formatCliCommand(\"moltbot doctor --fix\")}\" to apply legacy migrations.`)}}const normalized=normalizeLegacyConfigValues(candidate);if(normalized.changes.length>0){note(normalized.changes.join(\"\\n\"),\"Doctor changes\");candidate=normalized.config;pendingChanges=true;if(shouldRepair){cfg=normalized.config}else{fixHints.push(`Run \"${formatCliCommand(\"moltbot doctor --fix\")}\" to apply these changes.`)}}const autoEnable=applyPluginAutoEnable({config:candidate,env:process.env});if(autoEnable.changes.length>0){note(autoEnable.changes.join(\"\\n\"),\"Doctor changes\");candidate=autoEnable.config;pendingChanges=true;if(shouldRepair){cfg=autoEnable.config}else{fixHints.push(`Run \"${formatCliCommand(\"moltbot doctor --fix\")}\" to apply these changes.`)}}const unknown=stripUnknownConfigKeys(candidate);if(unknown.removed.length>0){const lines=unknown.removed.map(path=>`- ${path}`).join(\"\\n\");candidate=unknown.config;pendingChanges=true;if(shouldRepair){cfg=unknown.config;note(lines,\"Doctor changes\")}else{note(lines,\"Unknown config keys\");fixHints.push('Run \"moltbot doctor --fix\" to remove these keys.')}}if(!shouldRepair&&pendingChanges){const shouldApply=await params.confirm({message:\"Apply recommended config repairs now?\",initialValue:true});if(shouldApply){cfg=candidate;shouldWriteConfig=true}else if(fixHints.length>0){note(fixHints.join(\"\\n\"),\"Doctor\")}}noteOpencodeProviderOverrides(cfg);return{cfg,path:snapshot.path??CONFIG_PATH,shouldWriteConfig}}__name(loadAndMaybeMigrateDoctorConfig,\"loadAndMaybeMigrateDoctorConfig\");export{loadAndMaybeMigrateDoctorConfig};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/nettomello/CODIGOS/neobot/src/commands/doctor-config-flow.ts"],"sourcesContent":[null]}}