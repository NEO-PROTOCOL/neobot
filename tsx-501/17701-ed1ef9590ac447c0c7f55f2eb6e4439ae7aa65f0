{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{Chalk}from\"chalk\";import{CHAT_CHANNEL_ORDER}from\"../channels/registry.js\";import{defaultRuntime}from\"../runtime.js\";import{getConsoleSettings,shouldLogSubsystemToConsole}from\"./console.js\";import{isVerbose}from\"../globals.js\";import{levelToMinLevel}from\"./levels.js\";import{getChildLogger}from\"./logger.js\";import{loggingState}from\"./state.js\";import{clearActiveProgressLine}from\"../terminal/progress-line.js\";function shouldLogToConsole(level,settings){if(settings.level===\"silent\")return false;const current=levelToMinLevel(level);const min=levelToMinLevel(settings.level);return current<=min}__name(shouldLogToConsole,\"shouldLogToConsole\");function isRichConsoleEnv(){const term=(process.env.TERM??\"\").toLowerCase();if(process.env.COLORTERM||process.env.TERM_PROGRAM)return true;return term.length>0&&term!==\"dumb\"}__name(isRichConsoleEnv,\"isRichConsoleEnv\");function getColorForConsole(){const hasForceColor=typeof process.env.FORCE_COLOR===\"string\"&&process.env.FORCE_COLOR.trim().length>0&&process.env.FORCE_COLOR.trim()!==\"0\";if(process.env.NO_COLOR&&!hasForceColor)return new Chalk({level:0});const hasTty=Boolean(process.stdout.isTTY||process.stderr.isTTY);return hasTty||isRichConsoleEnv()?new Chalk({level:1}):new Chalk({level:0})}__name(getColorForConsole,\"getColorForConsole\");const SUBSYSTEM_COLORS=[\"cyan\",\"green\",\"yellow\",\"blue\",\"magenta\",\"red\"];const SUBSYSTEM_COLOR_OVERRIDES={\"gmail-watcher\":\"blue\"};const SUBSYSTEM_PREFIXES_TO_DROP=[\"gateway\",\"channels\",\"providers\"];const SUBSYSTEM_MAX_SEGMENTS=2;const CHANNEL_SUBSYSTEM_PREFIXES=new Set(CHAT_CHANNEL_ORDER);function pickSubsystemColor(color,subsystem){const override=SUBSYSTEM_COLOR_OVERRIDES[subsystem];if(override)return color[override];let hash=0;for(let i=0;i<subsystem.length;i+=1){hash=hash*31+subsystem.charCodeAt(i)|0}const idx=Math.abs(hash)%SUBSYSTEM_COLORS.length;const name=SUBSYSTEM_COLORS[idx];return color[name]}__name(pickSubsystemColor,\"pickSubsystemColor\");function formatSubsystemForConsole(subsystem){const parts=subsystem.split(\"/\").filter(Boolean);const original=parts.join(\"/\")||subsystem;while(parts.length>0&&SUBSYSTEM_PREFIXES_TO_DROP.includes(parts[0])){parts.shift()}if(parts.length===0)return original;if(CHANNEL_SUBSYSTEM_PREFIXES.has(parts[0])){return parts[0]}if(parts.length>SUBSYSTEM_MAX_SEGMENTS){return parts.slice(-SUBSYSTEM_MAX_SEGMENTS).join(\"/\")}return parts.join(\"/\")}__name(formatSubsystemForConsole,\"formatSubsystemForConsole\");function stripRedundantSubsystemPrefixForConsole(message,displaySubsystem){if(!displaySubsystem)return message;if(message.startsWith(\"[\")){const closeIdx=message.indexOf(\"]\");if(closeIdx>1){const bracketTag=message.slice(1,closeIdx);if(bracketTag.toLowerCase()===displaySubsystem.toLowerCase()){let i2=closeIdx+1;while(message[i2]===\" \")i2+=1;return message.slice(i2)}}}const prefix=message.slice(0,displaySubsystem.length);if(prefix.toLowerCase()!==displaySubsystem.toLowerCase())return message;const next=message.slice(displaySubsystem.length,displaySubsystem.length+1);if(next!==\":\"&&next!==\" \")return message;let i=displaySubsystem.length;while(message[i]===\" \")i+=1;if(message[i]===\":\")i+=1;while(message[i]===\" \")i+=1;return message.slice(i)}__name(stripRedundantSubsystemPrefixForConsole,\"stripRedundantSubsystemPrefixForConsole\");function formatConsoleLine(opts){const displaySubsystem=opts.style===\"json\"?opts.subsystem:formatSubsystemForConsole(opts.subsystem);if(opts.style===\"json\"){return JSON.stringify({time:new Date().toISOString(),level:opts.level,subsystem:displaySubsystem,message:opts.message,...opts.meta})}const color=getColorForConsole();const prefix=`[${displaySubsystem}]`;const prefixColor=pickSubsystemColor(color,displaySubsystem);const levelColor=opts.level===\"error\"||opts.level===\"fatal\"?color.red:opts.level===\"warn\"?color.yellow:opts.level===\"debug\"||opts.level===\"trace\"?color.gray:color.cyan;const displayMessage=stripRedundantSubsystemPrefixForConsole(opts.message,displaySubsystem);const time=(()=>{if(opts.style===\"pretty\"){return color.gray(new Date().toISOString().slice(11,19))}if(loggingState.consoleTimestampPrefix){return color.gray(new Date().toISOString())}return\"\"})();const prefixToken=prefixColor(prefix);const head=[time,prefixToken].filter(Boolean).join(\" \");return`${head} ${levelColor(displayMessage)}`}__name(formatConsoleLine,\"formatConsoleLine\");function writeConsoleLine(level,line){clearActiveProgressLine();const sanitized=process.platform===\"win32\"&&process.env.GITHUB_ACTIONS===\"true\"?line.replace(/[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]/g,\"?\").replace(/[\\uD800-\\uDFFF]/g,\"?\"):line;const sink=loggingState.rawConsole??console;if(loggingState.forceConsoleToStderr||level===\"error\"||level===\"fatal\"){(sink.error??console.error)(sanitized)}else if(level===\"warn\"){(sink.warn??console.warn)(sanitized)}else{(sink.log??console.log)(sanitized)}}__name(writeConsoleLine,\"writeConsoleLine\");function logToFile(fileLogger,level,message,meta){if(level===\"silent\")return;const safeLevel=level;const method=fileLogger[safeLevel];if(typeof method!==\"function\")return;if(meta&&Object.keys(meta).length>0){method.call(fileLogger,meta,message)}else{method.call(fileLogger,message)}}__name(logToFile,\"logToFile\");function createSubsystemLogger(subsystem){let fileLogger=null;const getFileLogger=__name(()=>{if(!fileLogger)fileLogger=getChildLogger({subsystem});return fileLogger},\"getFileLogger\");const emit=__name((level,message,meta)=>{const consoleSettings=getConsoleSettings();let consoleMessageOverride;let fileMeta=meta;if(meta&&Object.keys(meta).length>0){const{consoleMessage:consoleMessage2,...rest}=meta;if(typeof consoleMessage2===\"string\"){consoleMessageOverride=consoleMessage2}fileMeta=Object.keys(rest).length>0?rest:void 0}logToFile(getFileLogger(),level,message,fileMeta);if(!shouldLogToConsole(level,{level:consoleSettings.level}))return;if(!shouldLogSubsystemToConsole(subsystem))return;const consoleMessage=consoleMessageOverride??message;if(!isVerbose()&&subsystem===\"agent/embedded\"&&/(sessionId|runId)=probe-/.test(consoleMessage)){return}const line=formatConsoleLine({level,subsystem,message:consoleSettings.style===\"json\"?message:consoleMessage,style:consoleSettings.style,meta:fileMeta});writeConsoleLine(level,line)},\"emit\");const logger={subsystem,trace:__name((message,meta)=>emit(\"trace\",message,meta),\"trace\"),debug:__name((message,meta)=>emit(\"debug\",message,meta),\"debug\"),info:__name((message,meta)=>emit(\"info\",message,meta),\"info\"),warn:__name((message,meta)=>emit(\"warn\",message,meta),\"warn\"),error:__name((message,meta)=>emit(\"error\",message,meta),\"error\"),fatal:__name((message,meta)=>emit(\"fatal\",message,meta),\"fatal\"),raw:__name(message=>{logToFile(getFileLogger(),\"info\",message,{raw:true});if(shouldLogSubsystemToConsole(subsystem)){if(!isVerbose()&&subsystem===\"agent/embedded\"&&/(sessionId|runId)=probe-/.test(message)){return}writeConsoleLine(\"info\",message)}},\"raw\"),child:__name(name=>createSubsystemLogger(`${subsystem}/${name}`),\"child\")};return logger}__name(createSubsystemLogger,\"createSubsystemLogger\");function runtimeForLogger(logger,exit=defaultRuntime.exit){return{log:__name(message=>logger.info(message),\"log\"),error:__name(message=>logger.error(message),\"error\"),exit}}__name(runtimeForLogger,\"runtimeForLogger\");function createSubsystemRuntime(subsystem,exit=defaultRuntime.exit){return runtimeForLogger(createSubsystemLogger(subsystem),exit)}__name(createSubsystemRuntime,\"createSubsystemRuntime\");export{createSubsystemLogger,createSubsystemRuntime,runtimeForLogger,stripRedundantSubsystemPrefixForConsole};\n","warnings":[],"map":{"version":3,"mappings":"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","names":["i","consoleMessage"],"ignoreList":[],"sources":["/Users/nettomello/CODIGOS/neobot/src/logging/subsystem.ts"],"sourcesContent":[null]}}