{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{createRequire}from\"node:module\";import fs from\"node:fs\";import path from\"node:path\";import{Logger as TsLogger}from\"tslog\";import{levelToMinLevel,normalizeLogLevel}from\"./levels.js\";import{readLoggingConfig}from\"./config.js\";import{loggingState}from\"./state.js\";const DEFAULT_LOG_DIR=\"/tmp/moltbot\";const DEFAULT_LOG_FILE=path.join(DEFAULT_LOG_DIR,\"moltbot.log\");const LOG_PREFIX=\"moltbot\";const LOG_SUFFIX=\".log\";const MAX_LOG_AGE_MS=24*60*60*1e3;const requireConfig=createRequire(import.meta.url);const externalTransports=new Set;function attachExternalTransport(logger,transport){logger.attachTransport(logObj=>{if(!externalTransports.has(transport))return;try{transport(logObj)}catch{}})}__name(attachExternalTransport,\"attachExternalTransport\");function resolveSettings(){let cfg=loggingState.overrideSettings??readLoggingConfig();if(!cfg){try{const loaded=requireConfig(\"../config/config.js\");cfg=loaded.loadConfig?.().logging}catch{cfg=void 0}}const level=normalizeLogLevel(cfg?.level,\"info\");const file=cfg?.file??defaultRollingPathForToday();return{level,file}}__name(resolveSettings,\"resolveSettings\");function settingsChanged(a,b){if(!a)return true;return a.level!==b.level||a.file!==b.file}__name(settingsChanged,\"settingsChanged\");function isFileLogLevelEnabled(level){const settings=loggingState.cachedSettings??resolveSettings();if(!loggingState.cachedSettings)loggingState.cachedSettings=settings;if(settings.level===\"silent\")return false;return levelToMinLevel(level)<=levelToMinLevel(settings.level)}__name(isFileLogLevelEnabled,\"isFileLogLevelEnabled\");function buildLogger(settings){fs.mkdirSync(path.dirname(settings.file),{recursive:true});if(isRollingPath(settings.file)){pruneOldRollingLogs(path.dirname(settings.file))}const logger=new TsLogger({name:\"moltbot\",minLevel:levelToMinLevel(settings.level),type:\"hidden\"});logger.attachTransport(logObj=>{try{const time=logObj.date?.toISOString?.()??new Date().toISOString();const line=JSON.stringify({...logObj,time});fs.appendFileSync(settings.file,`${line}\n`,{encoding:\"utf8\"})}catch{}});for(const transport of externalTransports){attachExternalTransport(logger,transport)}return logger}__name(buildLogger,\"buildLogger\");function getLogger(){const settings=resolveSettings();const cachedLogger=loggingState.cachedLogger;const cachedSettings=loggingState.cachedSettings;if(!cachedLogger||settingsChanged(cachedSettings,settings)){loggingState.cachedLogger=buildLogger(settings);loggingState.cachedSettings=settings}return loggingState.cachedLogger}__name(getLogger,\"getLogger\");function getChildLogger(bindings,opts){const base=getLogger();const minLevel=opts?.level?levelToMinLevel(opts.level):void 0;const name=bindings?JSON.stringify(bindings):void 0;return base.getSubLogger({name,minLevel,prefix:bindings?[name??\"\"]:[]})}__name(getChildLogger,\"getChildLogger\");function toPinoLikeLogger(logger,level){const buildChild=__name(bindings=>toPinoLikeLogger(logger.getSubLogger({name:bindings?JSON.stringify(bindings):void 0}),level),\"buildChild\");return{level,child:buildChild,trace:__name((...args)=>logger.trace(...args),\"trace\"),debug:__name((...args)=>logger.debug(...args),\"debug\"),info:__name((...args)=>logger.info(...args),\"info\"),warn:__name((...args)=>logger.warn(...args),\"warn\"),error:__name((...args)=>logger.error(...args),\"error\"),fatal:__name((...args)=>logger.fatal(...args),\"fatal\")}}__name(toPinoLikeLogger,\"toPinoLikeLogger\");function getResolvedLoggerSettings(){return resolveSettings()}__name(getResolvedLoggerSettings,\"getResolvedLoggerSettings\");function setLoggerOverride(settings){loggingState.overrideSettings=settings;loggingState.cachedLogger=null;loggingState.cachedSettings=null;loggingState.cachedConsoleSettings=null}__name(setLoggerOverride,\"setLoggerOverride\");function resetLogger(){loggingState.cachedLogger=null;loggingState.cachedSettings=null;loggingState.cachedConsoleSettings=null;loggingState.overrideSettings=null}__name(resetLogger,\"resetLogger\");function registerLogTransport(transport){externalTransports.add(transport);const logger=loggingState.cachedLogger;if(logger){attachExternalTransport(logger,transport)}return()=>{externalTransports.delete(transport)}}__name(registerLogTransport,\"registerLogTransport\");function formatLocalDate(date){const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,\"0\");const day=String(date.getDate()).padStart(2,\"0\");return`${year}-${month}-${day}`}__name(formatLocalDate,\"formatLocalDate\");function defaultRollingPathForToday(){const today=formatLocalDate(new Date);return path.join(DEFAULT_LOG_DIR,`${LOG_PREFIX}-${today}${LOG_SUFFIX}`)}__name(defaultRollingPathForToday,\"defaultRollingPathForToday\");function isRollingPath(file){const base=path.basename(file);return base.startsWith(`${LOG_PREFIX}-`)&&base.endsWith(LOG_SUFFIX)&&base.length===`${LOG_PREFIX}-YYYY-MM-DD${LOG_SUFFIX}`.length}__name(isRollingPath,\"isRollingPath\");function pruneOldRollingLogs(dir){try{const entries=fs.readdirSync(dir,{withFileTypes:true});const cutoff=Date.now()-MAX_LOG_AGE_MS;for(const entry of entries){if(!entry.isFile())continue;if(!entry.name.startsWith(`${LOG_PREFIX}-`)||!entry.name.endsWith(LOG_SUFFIX))continue;const fullPath=path.join(dir,entry.name);try{const stat=fs.statSync(fullPath);if(stat.mtimeMs<cutoff){fs.rmSync(fullPath,{force:true})}}catch{}}}catch{}}__name(pruneOldRollingLogs,\"pruneOldRollingLogs\");export{DEFAULT_LOG_DIR,DEFAULT_LOG_FILE,getChildLogger,getLogger,getResolvedLoggerSettings,isFileLogLevelEnabled,registerLogTransport,resetLogger,setLoggerOverride,toPinoLikeLogger};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/nettomello/CODIGOS/neobot/src/logging/logger.ts"],"sourcesContent":[null]}}